generator client {
  // provider = "prisma-client"
  provider = "prisma-client-js"
  // output   = "../generated/client"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

//  ---------------- ↓↓↓↓

// Airline
// AirlinePersonal
// Company
// Log
// Message
// Report
// Request
// User

//  ---------------- ↑↑↑↑

// enum  ---------------- ↓↓↓↓

enum Role {
  SUPERADMIN
  DISPATCHERADMIN
  HOTELADMIN
  AIRLINEADMIN
  DISPATCHERMODERATOR
  HOTELMODERATOR
  AIRLINEMODERATOR
  DISPATCHERUSER
  HOTELUSER
  AIRLINEUSER
  USER
}

enum TwoFAMethod {
  HOTP
  TOTP
}

// enum  ---------------- ↑↑↑↑

// type  ---------------- ↓↓↓↓

type Information {
  country     String?
  city        String?
  address     String?
  index       String?
  email       String?
  number      String?
  inn         String?
  ogrn        String?
  rs          String?
  bank        String?
  bik         String?
  link        String?
  description String?
  // airport String?
}

// type  ---------------- ↑↑↑↑

// Пользователи  ---------------- ↓↓↓↓

model User {
  id                   String                @id @default(auto()) @map("_id") @db.ObjectId
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  lastSeen             DateTime?
  name                 String
  email                String                @unique
  number               String?
  login                String                @unique
  password             String
  images               String[]
  role                 Role
  // position             String?
  sender               Request[]             @relation(name: "sender")
  receiver             Request[]             @relation(name: "receiver")
  airline              Airline?              @relation(fields: [airlineId], references: [id], onDelete: NoAction)
  airlineId            String?               @db.ObjectId
  airlineDepartment    AirlineDepartment?    @relation(fields: [airlineDepartmentId], references: [id], onDelete: NoAction)
  airlineDepartmentId  String?               @db.ObjectId
  chats                ChatUser[]
  messageSender        Message[]             @relation(name: "messageSender")
  messageReceiver      Message[]             @relation(name: "messageReceiver")
  logs                 Log[]
  dispatcher           Boolean?              @default(false)
  support              Boolean?              @default(false)
  refreshToken         String?
  fingerprint          String?
  is2FAEnabled         Boolean               @default(false)
  twoFASecret          String?
  twoFAMethod          TwoFAMethod?
  messageRead          MessageRead[]
  NotificationRead     NotificationRead[]
  resetPasswordToken   String? // для хранения токена восстановления
  resetPasswordExpires DateTime? // срок действия токена
  active               Boolean               @default(true)
  position             Position?             @relation(fields: [positionId], references: [id])
  positionId           String?               @db.ObjectId
  postedRequests       Request[]             @relation(name: "posted")
  Transfer             Transfer[]
  TransferChat         TransferChat[]
  TransferMessage      TransferMessage[]
  TransferMessageRead  TransferMessageRead[]
}

model PositionOnDepartment {
  id                  String            @id @default(auto()) @map("_id") @db.ObjectId
  airlineDepartment   AirlineDepartment @relation(fields: [airlineDepartmentId], references: [id], onDelete: Cascade)
  airlineDepartmentId String            @db.ObjectId
  position            Position          @relation(fields: [positionId], references: [id], onDelete: Cascade)
  positionId          String            @db.ObjectId
  // hotelChess HotelChess[]
  // capacity   Int?
  // passengers Passenger[]

  @@unique([airlineDepartmentId, positionId])
}

model Position {
  id                String                 @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  separator         String?
  category          String?
  user              User[]
  airlinePersonal   AirlinePersonal[]
  airlineDepartment PositionOnDepartment[]
  // airline           Airline?               @relation(fields: [airlineId], references: [id], onDelete: NoAction)
  // airlineId         String?                @db.ObjectId
  // airlineDepartment   AirlineDepartment? @relation(fields: [airlineDepartmentId], references: [id])
  // airlineDepartmentId String?            @db.ObjectId
  // hotel             Hotel?                 @relation(fields: [hotelId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  // hotelId           String?                @db.ObjectId
}

// Пользователи  ---------------- ↑↑↑↑

// Авиакомпании  ---------------- ↓↓↓↓

model Airline {
  id           String              @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  nameFull     String?
  images       String[]
  information  Information?
  department   AirlineDepartment[]
  staff        AirlinePersonal[]
  request      Request[]
  user         User[]
  logs         Log[]
  savedReport  SavedReport[]
  chat         Chat[]
  Notification Notification[]
  active       Boolean             @default(true)
  transfers    Transfer[]
}

model AirlineDepartment {
  id        String                 @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String?
  staff     AirlinePersonal[]
  users     User[]
  airline   Airline                @relation(fields: [airlineId], references: [id], onDelete: Cascade)
  airlineId String                 @db.ObjectId
  active    Boolean                @default(true)
  position  PositionOnDepartment[]
}

model AirlinePersonal {
  id                  String                @id @default(auto()) @map("_id") @db.ObjectId
  name                String
  number              String?
  email               String?
  password            String?
  gender              String?
  married             Boolean?              @default(false)
  husband             AirlinePersonal?      @relation(name: "Marriage", fields: [husbandId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  husbandId           String?               @db.ObjectId
  marriedTo           AirlinePersonal[]     @relation(name: "Marriage")
  airline             Airline?              @relation(fields: [airlineId], references: [id], onDelete: NoAction)
  airlineId           String?               @db.ObjectId
  department          AirlineDepartment?    @relation(fields: [departmentId], references: [id], onDelete: NoAction)
  departmentId        String?               @db.ObjectId
  request             Request[]
  // hotelChess   HotelChess[]
  active              Boolean               @default(true)
  position            Position?             @relation(fields: [positionId], references: [id])
  positionId          String?               @db.ObjectId
  TransferPassenger   TransferPassenger[]
  TransferReview      TransferReview[]
  TransferChat        TransferChat[]
  TransferMessage     TransferMessage[]
  TransferMessageRead TransferMessageRead[]
}

// Авиакомпании  ---------------- ↑↑↑↑

// Компании  ---------------- ↓↓↓↓

model Company {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  information Information?
}

// Компании  ---------------- ↑↑↑↑

model Airport {
  id      String    @id @default(auto()) @map("_id") @db.ObjectId
  name    String?
  code    String?
  city    String?
  request Request[]
}

model City {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  city   String
  region String
}

// Заявка  ---------------- ↓↓↓↓

model Request {
  id            String           @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  placementAt   DateTime?        @map("placement_at")
  sender        User             @relation(name: "sender", fields: [senderId], references: [id])
  senderId      String           @db.ObjectId
  airport       Airport?         @relation(fields: [airportId], references: [id])
  airportId     String?          @db.ObjectId
  airline       Airline          @relation(fields: [airlineId], references: [id], onDelete: NoAction)
  airlineId     String           @db.ObjectId
  person        AirlinePersonal? @relation(fields: [personId], references: [id], onDelete: NoAction)
  personId      String?          @db.ObjectId
  arrival       DateTime
  departure     DateTime
  requestNumber String           @unique
  roomCategory  String?
  roomNumber    String?

  receiver   User?   @relation(name: "receiver", fields: [receiverId], references: [id])
  receiverId String? @db.ObjectId
  posted     User?   @relation(name: "posted", fields: [postedId], references: [id])
  postedId   String? @db.ObjectId
  chat       Chat[]
  status     String  @default("created")

  logs          Log[]
  archive       Boolean        @default(false)
  files         String[]
  reserve       Boolean        @default(false)
  Notifications Notification[]
}

// Заявка  ---------------- ↑↑↑↑

// Чаты/сообщения  ---------------- ↓↓↓↓

model Chat {
  id           String         @id @default(auto()) @map("_id") @db.ObjectId
  request      Request?       @relation(fields: [requestId], references: [id], onDelete: Cascade)
  requestId    String?        @db.ObjectId
  messages     Message[]
  participants ChatUser[]
  createdAt    DateTime       @default(now())
  isSupport    Boolean        @default(false)
  separator    String?
  airline      Airline?       @relation(fields: [airlineId], references: [id], onDelete: Cascade)
  airlineId    String?        @db.ObjectId
  Notification Notification[]
}

model Message {
  id           String         @id @default(auto()) @map("_id") @db.ObjectId
  text         String
  sender       User           @relation(name: "messageSender", fields: [senderId], references: [id], onDelete: Cascade)
  senderId     String         @db.ObjectId
  receiver     User?          @relation(name: "messageReceiver", fields: [receiverId], references: [id], onDelete: NoAction)
  receiverId   String?        @db.ObjectId
  chat         Chat?          @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId       String?        @db.ObjectId
  createdAt    DateTime       @default(now())
  isRead       Boolean        @default(false)
  readBy       MessageRead[]
  separator    String?
  Notification Notification[]
}

model MessageRead {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  readAt    DateTime @default(now())

  @@unique([messageId, userId])
}

model ChatUser {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  chat              Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId            String    @db.ObjectId
  user              User      @relation(fields: [userId], references: [id])
  userId            String    @db.ObjectId
  lastReadMessageAt DateTime?

  @@unique([chatId, userId])
}

// Чаты/сообщения  ---------------- ↑↑↑↑

// Логи  ---------------- ↓↓↓↓

model Log {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  user        User?    @relation(fields: [userId], references: [id])
  userId      String?  @db.ObjectId
  airline     Airline? @relation(fields: [airlineId], references: [id])
  airlineId   String?  @db.ObjectId
  request     Request? @relation(fields: [requestId], references: [id])
  requestId   String?  @db.ObjectId
  action      String
  reason      String?
  description String
  oldData     String?
  newData     String?
  createdAt   DateTime @default(now())
}

// Логи  ---------------- ↑↑↑↑

// Отчёты  ---------------- ↓↓↓↓

model SavedReport {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  url       String
  airline   Airline? @relation(fields: [airlineId], references: [id])
  airlineId String?  @db.ObjectId
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())
  separator String?
}

// Отчёты  ---------------- ↑↑↑↑

model Notification {
  id          String                   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt   DateTime                 @default(now())
  readBy      NotificationRead[]
  request     Request?                 @relation(fields: [requestId], references: [id])
  requestId   String?                  @db.ObjectId
  airline     Airline?                 @relation(fields: [airlineId], references: [id])
  airlineId   String?                  @db.ObjectId
  chat        Chat?                    @relation(fields: [chatId], references: [id])
  chatId      String?                  @db.ObjectId
  message     Message?                 @relation(fields: [messageId], references: [id])
  messageId   String?                  @db.ObjectId
  description NotificationDescription?
}

type NotificationDescription {
  action      String?
  reason      String?
  description String?
}

model NotificationRead {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  notificationId String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  readAt         DateTime     @default(now())

  @@unique([notificationId, userId])
}

// ====================== TRANSFER / DRIVER ======================

// --- Enums
enum TransferStatus {
  PENDING
  ASSIGNED
  ACCEPTED
  ARRIVED
  IN_PROGRESS_TO_CLIENT
  IN_PROGRESS_TO_HOTEL
  COMPLETED
  CANCELLED
}

enum TransferChatType {
  DISPATCHER_DRIVER
  DISPATCHER_PERSONAL
  DRIVER_PERSONAL
}

enum ActorType {
  USER // диспетчер (модель User)
  DRIVER // модель Driver
  PERSONAL // модель AirlinePersonal (пассажир)
}

enum DriverRegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TransferReviewAuthor {
  DRIVER
  PERSONAL
}

// --- Embedded types
type DriverDocuments {
  driverPhoto  String[]
  carPhotos    String[]
  stsPhoto     String[]
  ptsPhoto     String[]
  osagoPhoto   String[]
  licensePhoto String[]
}

type GeoPoint {
  lat       Float?
  lng       Float?
  updatedAt DateTime?
}

// --- Organization
model Organization {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  information Information?
  drivers     Driver[]
  active      Boolean      @default(true)
}

// --- Driver
model Driver {
  id                     String                   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt              DateTime                 @default(now()) @map("created_at")
  updatedAt              DateTime                 @updatedAt @map("updated_at")
  name                   String
  number                 String?
  email                  String?                  @unique
  password               String?
  car                    String?
  vehicleNumber          String?
  driverLicenseNumber    String?
  driverLicenseIssueYear Int?
  extraEquipment         String[] // доп. оборудование
  organization           Organization?            @relation(fields: [organizationId], references: [id])
  organizationId         String?                  @db.ObjectId
  organizationConfirmed  Boolean?
  documents              DriverDocuments?
  registrationStatus     DriverRegistrationStatus @default(PENDING)
  location               GeoPoint?
  rating                 Float?
  transfers              Transfer[]
  transferMessages       TransferMessage[]        @relation("DriverAuthor")
  active                 Boolean                  @default(true)
  TransferReview         TransferReview[]
  TransferChat           TransferChat[]
  TransferMessageRead    TransferMessageRead[]
}

// --- Связка "заявка ↔ пассажиры (AirlinePersonal)"
model TransferPassenger {
  id         String          @id @default(auto()) @map("_id") @db.ObjectId
  transfer   Transfer        @relation(fields: [transferId], references: [id], onDelete: Cascade)
  transferId String          @db.ObjectId
  personal   AirlinePersonal @relation(fields: [personalId], references: [id], onDelete: Cascade)
  personalId String          @db.ObjectId

  @@unique([transferId, personalId])
}

// --- Transfer (заявка)
model Transfer {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  fromAddress      String // адрес откуда
  toAddress        String // адрес куда
  additionalPoints String[] // доп. точки
  passengersCount  Int // кол-во пассажиров

  dispatcher   User?   @relation(fields: [dispatcherId], references: [id])
  dispatcherId String? @db.ObjectId

  // назначенный водитель (может быть пусто до назначения)
  driver   Driver? @relation(fields: [driverId], references: [id])
  driverId String? @db.ObjectId

  airline   Airline? @relation(fields: [airlineId], references: [id])
  airlineId String?  @db.ObjectId

  // пассажиры (сотрудники авиакомпаний)
  persons TransferPassenger[]

  description   String? // комментарий
  cancellReason String?
  baggage       String? // инфо о багаже
  files         String[] // вложения/фото при необходимости

  scheduledPickupAt     DateTime? // к скольки приехать к пассажиру
  driverAssignmentAt    DateTime?
  orderAcceptanceAt     DateTime?
  arrivedToPassengerAt  DateTime?
  departedAt            DateTime?
  arrivedAt             DateTime?
  finishedAt            DateTime?
  travelDurationMinutes Int? // время в пути (мин)

  status TransferStatus @default(PENDING)

  // 3 чата на заявку
  chats TransferChat[]

  // отзывы двух сторон (уникально по автору на заявку)
  reviews TransferReview[]
}

// --- Отзывы (оценка/комментарий) со стороны водителя или пассажира
model TransferReview {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  transfer   Transfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  transferId String   @db.ObjectId

  authorType TransferReviewAuthor // DRIVER | PERSONAL
  driver     Driver?              @relation(fields: [driverId], references: [id])
  driverId   String?              @db.ObjectId
  personal   AirlinePersonal?     @relation(fields: [personalId], references: [id])
  personalId String?              @db.ObjectId

  rating    Int? // 1..5
  comment   String?
  createdAt DateTime @default(now())

  @@unique([transferId, authorType]) // по 1 отзыву с каждой стороны
}

// --- Чаты по заявке (ровно три типа на заявку)
model TransferChat {
  id         String           @id @default(auto()) @map("_id") @db.ObjectId
  transfer   Transfer         @relation(fields: [transferId], references: [id], onDelete: Cascade)
  transferId String           @db.ObjectId
  type       TransferChatType // DISPATCHER_DRIVER / DISPATCHER_PERSONAL / DRIVER_PERSONAL
  createdAt  DateTime         @default(now())

  // Участники конкретного чата (фиксированный набор по типу)
  dispatcher   User?   @relation(fields: [dispatcherId], references: [id])
  dispatcherId String? @db.ObjectId
  driver       Driver? @relation(fields: [driverId], references: [id])
  driverId     String? @db.ObjectId

  // В заявке может быть несколько человек, можно сделать связанную модель
  personal   AirlinePersonal? @relation(fields: [personalId], references: [id])
  personalId String?          @db.ObjectId

  messages TransferMessage[]

  @@unique([transferId, type]) // не более одного чата каждого типа на заявку
}

// --- Сообщения в чатах трансфера с универсальным автором
model TransferMessage {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  chat      TransferChat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId    String       @db.ObjectId
  text      String
  createdAt DateTime     @default(now())
  isRead    Boolean      @default(false)

  authorType ActorType

  // автор-юзер (диспетчер)
  senderUser   User?   @relation(fields: [senderUserId], references: [id])
  senderUserId String? @db.ObjectId

  // автор-водитель
  senderDriver   Driver? @relation("DriverAuthor", fields: [senderDriverId], references: [id])
  senderDriverId String? @db.ObjectId

  // автор-пассажир (AirlinePersonal)
  senderPersonal   AirlinePersonal? @relation(fields: [senderPersonalId], references: [id])
  senderPersonalId String?          @db.ObjectId

  readBy    TransferMessageRead[]
  separator String?
}

// отметки о прочтении для сообщений трансфера
model TransferMessageRead {
  id         String           @id @default(auto()) @map("_id") @db.ObjectId
  message    TransferMessage  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId  String           @db.ObjectId
  readerType ActorType
  user       User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String?          @db.ObjectId
  driver     Driver?          @relation(fields: [driverId], references: [id], onDelete: Cascade)
  driverId   String?          @db.ObjectId
  personal   AirlinePersonal? @relation(fields: [personalId], references: [id], onDelete: Cascade)
  personalId String?          @db.ObjectId
  readAt     DateTime         @default(now())
}
